# ---- Top-level CMakeLists.txt (drop in Ray-Tracer/) ----
cmake_minimum_required(VERSION 3.16)

project(ray_tracer
  VERSION 0.1.0
  DESCRIPTION "Tiny C++ ray tracer"
  LANGUAGES CXX)

# C++ standard
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Export compile_commands.json (useful for clangd, VSCode)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# Warnings
if(MSVC)
  add_compile_options(/W4)
else()
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# Source collection and target
file(GLOB_RECURSE RT_SOURCES CONFIGURE_DEPENDS "${CMAKE_CURRENT_SOURCE_DIR}/src/*.cpp")
if(NOT RT_SOURCES)
  message(FATAL_ERROR "No .cpp files found in src/. Make sure src/main.cpp exists.")
endif()

add_executable(ray_tracer ${RT_SOURCES})

# Include directory
target_include_directories(ray_tracer PRIVATE "${CMAKE_CURRENT_SOURCE_DIR}/inc")

# Threads (pthreads for MinGW/Unix; MSVC links a stub)
find_package(Threads REQUIRED)
target_link_libraries(ray_tracer PRIVATE Threads::Threads)

# ---- Optional install
install(TARGETS ray_tracer RUNTIME DESTINATION bin)

# ---- Generate a convenience Makefile inside src/ (only if missing)
set(_rt_makefile "${CMAKE_CURRENT_SOURCE_DIR}/src/Makefile")
if(NOT EXISTS "${_rt_makefile}")
  file(WRITE "${_rt_makefile}" [=[
# Minimal, portable Makefile (autogenerated by CMake)
# Usage:
#   make        -> build from main.cpp
#   make clean  -> remove build artifacts
#   make nuke   -> delete everything except main.cpp and this Makefile (DANGEROUS)

UNAME_S := $(shell uname -s 2>/dev/null)
ifeq ($(OS),Windows_NT)
  WINDOWS := 1
else ifneq (,$(findstring MINGW,$(UNAME_S)))
  WINDOWS := 1
else ifneq (,$(findstring MSYS,$(UNAME_S)))
  WINDOWS := 1
else
  WINDOWS := 0
endif

ifeq ($(WINDOWS),1)
  EXE := a.exe
  RM  := del /Q
  SHELL := cmd
else
  EXE := a.out
  RM  := rm -f
endif

CXX := g++
CXXFLAGS := -O2 -std=c++17
SRC := main.cpp

all: $(EXE)

$(EXE): $(SRC)
	$(CXX) $(CXXFLAGS) $(SRC) -o $(EXE)

clean:
	-$(RM) $(EXE)
	-$(RM) *.o
	-$(RM) *.obj
	-$(RM) *.ppm
	-$(RM) *.png
	-$(RM) *.tsv
ifeq ($(WINDOWS),1)
	-$(RM) *.exe 2>NUL
endif

# --- DANGEROUS ---
nuke:
ifeq ($(WINDOWS),1)
	@for %f in (*) do @if /I not "%f"=="main.cpp" if /I not "%f"=="Makefile" del /Q "%f"
else
	@find . -maxdepth 1 -type f ! -name 'main.cpp' ! -name 'Makefile' -exec rm -f {} +
endif

.PHONY: all clean nuke
]=])
endif()
